name: Publish LASER System- Development

on:
  push: 
    branches: [ "development" ]    
  pull_request:
    branches: [ "development" ]

jobs:
  build:  
    runs-on: windows-latest 
    env:                    
      VERSION: 2.0.3.10
      USER_NAME: MaleeshaRodrigo
      EMAIL: w1902272@my.westminster.ac.uk
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Chocolatey 
        uses: crazy-max/ghaction-chocolatey@v3
        with:
          args: -h
        
      - name: Install Crystal Report
        run: choco install crystalreports-for-visualstudio
        
      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v1.0.2
  
      - name: Setup Nuget
        uses: nuget/setup-nuget@v1
        with: 
          nuget-version: latest 
  
      - name: Restore NuGet Packages
        run: nuget restore

      - name: Create a new Branch
        run: |  
          git config --global user.email "${{env.EMAIL}}"
          git config --global user.name "${{env.USER_NAME}}"         
          git checkout -b feature-branch
          git push --set-upstream origin feature-branch
  
      - name: Build LASER System Project      
        working-directory: "./LASER System"
        run: msbuild 
  
      - name: Publish LASER System Project
        working-directory: "./LASER System"
        run: msbuild /t:publish /p:PublishDir="publish/" /property:UpdateEnabled=true /property:UpdateUrl="https://raw.githubusercontent.com/MaleeshaRodrigo/LASERSystem/main/LASER%20System/publish/"  /p:configuration="Release" /p:ApplicationVersion=${{env.VERSION}}

      - name: Commit the changes
        run: |
          git add . 
          git commit -m "v${{env.VERSION}} published"

      - name: Push the changes
        run: git push

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add new feature"
          branch: feature-branch
          base: development
          title: "New Feature Pull Request"
          body: "Description of the changes."

      - name: Merge Pull Request
        uses: pascalgn/automerge-action@v0.11.1
        with:
          PULL_REQUEST: ${{ steps.cpr.outputs.pull-request-number }}
          label: automerge
          delete-branch: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
